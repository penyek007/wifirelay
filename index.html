<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>WiFi контроллер</title>

<!-- PWA -->
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#6ec6ff">

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: Arial, sans-serif;
  min-height: 100svh;
  background: linear-gradient(180deg, #6ec6ff, #b3e5fc);
}

.wrapper {
  min-height: 100svh;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  padding-top: 60px;
}

.card {
  width: calc(100% - 32px);
  max-width: 360px;
  background: #fff;
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.15);
  text-align: center;
}

h2 { margin-top: 0; }

input {
  width: 100%;
  height: 52px;
  font-size: 16px;
  margin-bottom: 10px;
  border-radius: 10px;
  border: 1px solid #ccc;
  text-align: center;
}

button {
  width: 100%;
  height: 56px;
  font-size: 18px;
  margin-top: 10px;
  border: none;
  border-radius: 12px;
  background: #2196f3;
  color: white;
  cursor: pointer;
}

#overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.4);
  display: none;
  align-items: center;
  justify-content: center;
}

#overlay .card {
  max-width: 300px;
}
</style>
</head>

<body>

<div class="wrapper">
  <!-- LOGIN -->
  <div class="card" id="login">
    <h2>Вход</h2>
    <input id="password" type="password" placeholder="Пароль">
    <button onclick="login()">Войти</button>
  </div>

  <!-- MAIN -->
  <div class="card" id="main" style="display:none;">
    <h2>WiFi контроллер</h2>
    <button onclick="cmd('/r1')">Ворота</button>
    <button onclick="cmd('/r2')">Калитка</button>
    <button onclick="cmd('/r3')">Гараж</button>

    <button onclick="togglePwd()">Сменить пароль</button>

    <div id="pwd" style="display:none;">
      <input id="oldp" type="password" placeholder="Старый пароль">
      <input id="newp" type="password" placeholder="Новый пароль">
      <button onclick="changePwd()">Сохранить</button>
    </div>
  </div>
</div>

<!-- OVERLAY -->
<div id="overlay">
  <div class="card">
    <h3>Ошибка</h3>
    <p>Сервер временно недоступен</p>
    <button onclick="hideErr()">OK</button>
  </div>
</div>

<script>
const BASE = "http://217.169.91.213:1000";

function showErr(){ overlay.style.display="flex"; }
function hideErr(){ overlay.style.display="none"; }

async function sha256(t){
  const b=new TextEncoder().encode(t);
  const h=await crypto.subtle.digest("SHA-256",b);
  return [...new Uint8Array(h)].map(x=>x.toString(16).padStart(2,"0")).join("");
}

async function api(url, opt={}){
  try{
    const r = await fetch(BASE+url, opt);
    if(!r.ok) throw 0;
    return r;
  }catch{
    showErr();
    throw 0;
  }
}

async function login(){
  const h = await sha256(password.value);
  await api("/login",{method:"POST",body:h});
  loginDiv(false);
}

function loginDiv(ok){
  login.style.display = ok?"none":"block";
  main.style.display  = ok?"block":"none";
}

async function cmd(u){
  await api(u);
}

function togglePwd(){
  pwd.style.display = pwd.style.display==="none"?"block":"none";
}

async function changePwd(){
  const o = await sha256(oldp.value);
  const n = await sha256(newp.value);
  await api("/passwd",{method:"POST",body:o+":"+n});
  alert("Пароль изменён");
}

/* автологин */
api("/auth").then(()=>loginDiv(true)).catch(()=>{});

/* PWA */
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("/sw.js");
}
</script>

</body>
</html>
